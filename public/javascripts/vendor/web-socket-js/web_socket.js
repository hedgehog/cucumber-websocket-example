// Copyright: Hiroshi Ichikawa <http://gimite.net/en/>
// License: New BSD License
(function(){function i(){}if(!window.WebSocket){var f=window.console;f||(f={log:function(){},error:function(){}});if(swfobject.hasFlashPlayerVersion("9.0.0")){location.protocol=="file:"&&f.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://...");WebSocket=function(a,d,c,e,h){var b=this;b.readyState=WebSocket.CONNECTING;b.bufferedAmount=0;setTimeout(function(){WebSocket.__addTask(function(){b.__createFlash(a,
d,c,e,h)})},1)};WebSocket.prototype.__createFlash=function(a,d,c,e,h){var b=this;b.__flash=WebSocket.__flash.create(a,d,c||null,e||0,h||null);b.__flash.addEventListener("open",function(){try{b.readyState=b.__flash.getReadyState();b.__timer&&clearInterval(b.__timer);if(window.opera)b.__timer=setInterval(function(){b.__handleMessages()},500);b.onopen&&b.onopen()}catch(g){f.error(g.toString())}});b.__flash.addEventListener("close",function(){try{b.readyState=b.__flash.getReadyState();b.__timer&&clearInterval(b.__timer);
b.onclose&&b.onclose()}catch(g){f.error(g.toString())}});b.__flash.addEventListener("message",function(){try{b.__handleMessages()}catch(g){f.error(g.toString())}});b.__flash.addEventListener("error",function(){try{b.__timer&&clearInterval(b.__timer);b.onerror&&b.onerror()}catch(g){f.error(g.toString())}});b.__flash.addEventListener("stateChange",function(g){try{b.readyState=b.__flash.getReadyState();b.bufferedAmount=g.getBufferedAmount()}catch(j){f.error(j.toString())}})};WebSocket.prototype.send=
function(a){if(this.__flash)this.readyState=this.__flash.getReadyState();if(!this.__flash||this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";a=this.__flash.send(encodeURIComponent(a));if(a<0)return true;else{this.bufferedAmount=a;return false}};WebSocket.prototype.close=function(){if(this.__flash){this.readyState=this.__flash.getReadyState();if(!(this.readyState==WebSocket.CLOSED||this.readyState==WebSocket.CLOSING)){this.__flash.close();
this.readyState=WebSocket.CLOSED;this.__timer&&clearInterval(this.__timer);this.onclose&&setTimeout(this.onclose,1)}}};WebSocket.prototype.addEventListener=function(a,d){if(!("__events"in this))this.__events={};if(!(a in this.__events)){this.__events[a]=[];if("function"==typeof this["on"+a]){this.__events[a].defaultHandler=this["on"+a];this["on"+a]=this.__createEventHandler(this,a)}}this.__events[a].push(d)};WebSocket.prototype.removeEventListener=function(a,d){if(!("__events"in this))this.__events=
{};if(a in this.__events)for(var c=this.__events.length;c>-1;--c)if(d===this.__events[a][c]){this.__events[a].splice(c,1);break}};WebSocket.prototype.dispatchEvent=function(a){if(!("__events"in this))throw"UNSPECIFIED_EVENT_TYPE_ERR";if(!(a.type in this.__events))throw"UNSPECIFIED_EVENT_TYPE_ERR";for(var d=0,c=this.__events[a.type].length;d<c;++d){this.__events[a.type][d](a);if(a.cancelBubble)break}false!==a.returnValue&&"function"==typeof this.__events[a.type].defaultHandler&&this.__events[a.type].defaultHandler(a)};
WebSocket.prototype.__handleMessages=function(){for(var a=this.__flash.readSocketData(),d=0;d<a.length;d++){var c=decodeURIComponent(a[d]);try{if(this.onmessage){var e;if(window.MessageEvent&&!window.opera){e=document.createEvent("MessageEvent");e.initMessageEvent("message",false,false,c,null,null,window,null)}else e={data:c};this.onmessage(e)}}catch(h){f.error(h.toString())}}};WebSocket.prototype.__createEventHandler=function(a,d){return function(c){var e=new i;e.initEvent(d,true,true);e.target=
e.currentTarget=a;for(var h in c)e[h]=c[h];a.dispatchEvent(e,arguments)}};i.prototype.cancelable=true;i.prototype.cancelBubble=false;i.prototype.preventDefault=function(){if(this.cancelable)this.returnValue=false};i.prototype.stopPropagation=function(){this.cancelBubble=true};i.prototype.initEvent=function(a,d,c){this.type=a;this.cancelable=c;this.timeStamp=new Date};WebSocket.CONNECTING=0;WebSocket.OPEN=1;WebSocket.CLOSING=2;WebSocket.CLOSED=3;WebSocket.__tasks=[];WebSocket.__initialize=function(){if(WebSocket.__swfLocation)window.WEB_SOCKET_SWF_LOCATION=
WebSocket.__swfLocation;if(window.WEB_SOCKET_SWF_LOCATION){var a=document.createElement("div");a.id="webSocketContainer";a.style.position="absolute";if(WebSocket.__isFlashLite()){a.style.left="0px";a.style.top="0px"}else{a.style.left="-100px";a.style.top="-100px"}var d=document.createElement("div");d.id="webSocketFlash";a.appendChild(d);document.body.appendChild(a);swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","9.0.0",null,{bridgeName:"webSocket"},{hasPriority:true,allowScriptAccess:"always"},
null,function(c){c.success||f.error("[WebSocket] swfobject.embedSWF failed")});FABridge.addInitializationCallback("webSocket",function(){try{WebSocket.__flash=FABridge.webSocket.root();WebSocket.__flash.setCallerUrl(location.href);WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var c=0;c<WebSocket.__tasks.length;++c)WebSocket.__tasks[c]();WebSocket.__tasks=[]}catch(e){f.error("[WebSocket] "+e.toString())}})}else f.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf")};
WebSocket.__addTask=function(a){WebSocket.__flash?a():WebSocket.__tasks.push(a)};WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return false;var a=window.navigator.mimeTypes["application/x-shockwave-flash"];if(!a||!a.enabledPlugin||!a.enabledPlugin.filename)return false;return a.enabledPlugin.filename.match(/flashlite/i)?true:false};window.webSocketLog=function(a){f.log(decodeURIComponent(a))};window.webSocketError=function(a){f.error(decodeURIComponent(a))};
window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||(window.addEventListener?window.addEventListener("load",WebSocket.__initialize,false):window.attachEvent("onload",WebSocket.__initialize))}else f.error("Flash Player is not installed.")}})();
